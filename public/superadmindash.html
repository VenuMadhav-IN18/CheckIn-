<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Super Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div id="messageBox" class="alert d-none" role="alert"></div>
<div class="container mt-4">
  <h2 class="mb-4">Super Admin Dashboard</h2>
  <button id="logoutBtn" style="position: fixed;top: 12px;right: 15px;background-color: #ff4d4d;color: white;border: none;
  padding: 6px 10px;font-size: 13px;border-radius: 6px;cursor: pointer;box-shadow: 0 2px 5px rgba(0,0,0,0.2);
"> Logout</button>
  <div class="card mb-4">
    <div class="card-header">Admin Management</div>
    

    <div class="card-body">
      <form id="addAdminForm" class="mb-3">
        <input type="text" class="form-control mb-2" id="adminName" placeholder="Admin Name" required>
        <input type="email" class="form-control mb-2" id="adminEmail" placeholder="Admin Email" required>
        <input type="password" class="form-control mb-2" id="adminPass" placeholder="Password" required>
        <button type="submit" class="btn btn-primary">Add Admin</button>
      </form>

      <button class="btn btn-secondary" onclick="fetchAdmins()">View Admins</button>
      <ul id="adminsList" class="list-group mt-3"></ul>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">Site Management</div>
    <div class="card-body">
      <form id="addSiteForm" class="mb-3">
        <input type="text" class="form-control mb-2" id="siteName" placeholder="Site Name" required>
        <input type="text" class="form-control mb-2" id="siteLocation" placeholder="Location">
        <button type="submit" class="btn btn-success">Add Site</button>
      </form>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">Global Attendance</div>
    <div class="card-body">
      <input type="date" id="attendanceDate">
      <button class="btn btn-info" onclick="fetchAttendance()">Get Attendance</button>
      <table class="table mt-3">
        <thead><tr><th>Name</th><th>Role</th><th>Site</th><th>Check-in</th><th>Check-out</th><th>Status</th></tr></thead>
        <tbody id="attendanceTable"></tbody>
      </table>
    </div>
  </div>
</div>

<script>

const baseURL = "/superadmin"; 

function showMessage(text, type = "success") {
  const box = document.getElementById("messageBox");
  box.className = `alert alert-${type} mt-2`;
  box.textContent = text;
  box.classList.remove("d-none");
  setTimeout(() => box.classList.add("d-none"), 4000);
}

// Add Admin
const addAdminForm = document.getElementById("addAdminForm");
addAdminForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const adminName = document.getElementById("adminName").value.trim();
  const adminEmail = document.getElementById("adminEmail").value.trim();
  const adminPass = document.getElementById("adminPass").value.trim();

  try {
    const res = await fetch(`${baseURL}/add-admin`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ adminName, adminEmail, adminPass }),
    });
    const data = await res.json();
    if (res.ok) {
      showMessage(data.message || "Admin added", "success");
      addAdminForm.reset();
      fetchAdmins(); 
    } else {
      showMessage(data.error || JSON.stringify(data), "danger");
    }
  } catch (err) {
    showMessage("Request failed: " + err.message, "danger");
  }
});

// View Admins
async function fetchAdmins() {
  try {
    const res = await fetch(`${baseURL}/admins`);
    if (!res.ok) {
      const err = await res.json().catch(()=>({error:res.statusText}));
      showMessage("Failed to load admins: " + (err.error || res.statusText), "danger");
      return;
    }
    const data = await res.json();
    const list = document.getElementById("adminsList");
    list.innerHTML = "";
    if (!data || data.length === 0) {
      list.innerHTML = `<li class="list-group-item">No admins found</li>`;
      return;
    }
    data.forEach((admin) => {
      const li = document.createElement("li");
      li.className = "list-group-item d-flex justify-content-between align-items-start";
      li.innerHTML = `<div><strong>${admin.username}</strong><div class="small">${admin.email_id || 'No email'}</div></div>
                      <div class="small text-muted">Created: ${admin.created_at ? new Date(admin.created_at).toLocaleString() : '-'}</div>`;
      list.appendChild(li);
    });
  } catch (err) {
    showMessage("Failed to fetch admins: " + err.message, "danger");
  }
}

// Add Site
const addSiteForm = document.getElementById("addSiteForm");
addSiteForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const site_name = document.getElementById("siteName").value.trim();
  const location = document.getElementById("siteLocation").value.trim();

  try {
    const res = await fetch(`${baseURL}/add-site`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ site_name, location }),
    });
    const data = await res.json();
    if (res.ok) {
      showMessage(data.message || "Site added", "success");
      addSiteForm.reset();
    } else {
      showMessage(data.error || JSON.stringify(data), "danger");
    }
  } catch (err) {
    showMessage("Request failed: " + err.message, "danger");
  }
});

// Fetch Attendance
async function fetchAttendance() {
  const date = document.getElementById("attendanceDate").value;
  if (!date) {
    showMessage("Please select a date", "warning");
    return;
  }

  try {
    const res = await fetch(`${baseURL}/attendance?date=${encodeURIComponent(date)}`);
    if (!res.ok) {
      const err = await res.json().catch(()=>({error:res.statusText}));
      showMessage("Failed to load attendance: " + (err.error || res.statusText), "danger");
      return;
    }
    const data = await res.json();
    const tbody = document.getElementById("attendanceTable");
    tbody.innerHTML = "";
    if (!data || data.length === 0) {
      tbody.innerHTML = "<tr><td colspan='6'>No records found</td></tr>";
      return;
    }
    data.forEach((row) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${row.worker_name || "-"}</td>
        <td>${row.role || "-"}</td>
        <td>${row.site_name || "-"}</td>
        <td>${row.check_in ? new Date(row.check_in).toLocaleTimeString() : "-"}</td>
        <td>${row.check_out ? new Date(row.check_out).toLocaleTimeString() : "-"}</td>
        <td>${row.status || "-"}</td>
      `;
      tbody.appendChild(tr);
    });
  } catch (err) {
    showMessage("Failed to load attendance: " + err.message, "danger");
  }
}
// --- Super Admin Logout ---
document.getElementById("logoutBtn").addEventListener("click", () => {
  localStorage.removeItem("superAdmin");
  sessionStorage.clear();

  alert(" Logged out successfully!");
  window.location.href = "MainInterface.html"; // or your login page path
});

// Auto load admins on page open
fetchAdmins();
</script>

</body>
</html>
